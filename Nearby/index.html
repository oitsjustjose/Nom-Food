<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
		<title>Nom: Nearby</title>
		<link rel="icon" href="../img/app-icon.png">
		<link rel="stylesheet" type="text/css" href="../semantic/out/semantic.min.css">
		<link rel="stylesheet" type="text/css" href="../nom.css">
		<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
		<script src="../jquery-1.7.2.js"></script>
		<script src="../semantic/out/semantic.min.js"></script>
		<script src="../my-app.js"></script>
	</head>

	<body onLoad="getActiveUser()">
		<!--This is all stuff for the menubar-->
		<div class="ui large inverted teal top fixed menu">
			<div class="ui container">
				<a href=".." class="item">Home</a>
				<a href="../Nearby" class="header item">Nearby Menus</a>
				<a href="../Cooking" class="item">Want to cook for us?</a>
				<div class="right menu">
					<a href="../Account" class="item" id="user" onmouseover="mouseOver(this)" onmouseout="mouseOut(this)"></a>
				</div>
			</div>
		</div>
		
		<div class="pusher" style="padding-top: 40px;">
			<div class="ui vertical stripe quote segment">
				<div class="ui equal width internally celled grid" id="restaurants">
					<!-- Table Headers -->
					<div class="ui header" style="margin-top: 32px;">
						<h2>Restaurants within 25 miles</h2>
					</div>
					<table class="ui celled table">
						<tbody id="results">
						</tbody>
					</table>	
				</div>
			</div>
		</div>

		<script>
			// JS Geolocation stuff:
			getGeolocation();
			
			
			function longfunctionfirst(callback)
			{
				setTimeout(function()
				{
					// Do stuff here...?
					if(typeof callback == 'function')
					{
						callback();
					}
				}, 3000);
			};

			
			function getGeolocation()
			{
				if (navigator.geolocation)
				{
					navigator.geolocation.getCurrentPosition(getNearbyLocations);
				}
				else
				{
					alert("Geolocation is not supported by this browser...");
				}
			}
			
			function getNearbyLocations(position)
			{
				var lat = position.coords.latitude;
				var lon = position.coords.longitude;

				var database = firebase.database();

				$.getJSON(database.ref('Restaurants') + '.json', function(data) {
					var items = [];
					
					$.each( data, function( key, val ) {
						items[key] = val;
					});
					
					var tally = 0;

					for (var i in items)
					{						
						var radlat1 = Math.PI * lat / 180;
						var radlat2 = Math.PI * items[i]["lat"] / 180;
						var theta = lon - items[i]["lon"];
						var radtheta = Math.PI * theta / 180;
						var distance = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
						distance = Math.acos(distance);
						distance = distance * 180 / Math.PI;
						distance = distance * 60 * 1.1515;
						
						if (!isNaN(distance) && distance <= 25)
						{
							document.getElementById("results").innerHTML += "<tr id=\"restaurant_" + tally + "\"></tr>";
							document.getElementById("restaurant_" + tally).innerHTML += "<td>" + i + " (owned by " + items[i]["owner_first"] + " " + items[i]["owner_last"] + ")" + "</td>";
							document.getElementById("restaurant_" + tally).innerHTML += "<td>" + items[i]["food_type"] + "</td>";
							document.getElementById("restaurant_" + tally).innerHTML += "<td>" + items[i]["address"] + ", " + items[i]["area_code"] + "</td>";
							document.getElementById("restaurant_" + tally).innerHTML += "<td>" + Math.round(distance) + " mi" + "</td>";
							tally++;
						}	
					}
				});
			}
		</script>
	</body>
</html>
